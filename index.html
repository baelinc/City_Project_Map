<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sulphur Project Portal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f8f9fa; color: #333; }
        header { background: #007bff; color: white; padding: 20px; text-align: center; border-bottom: 4px solid #0056b3; }
        .controls { background: white; padding: 15px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #007bff; position: sticky; top: 0; z-index: 1000; }
        #map { height: 450px; width: 100%; border-bottom: 1px solid #ccc; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; border-left: 6px solid #ccc; transition: 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .progress-container { background: #eee; border-radius: 10px; height: 12px; width: 100%; margin: 10px 0; overflow: hidden; position: relative; }
        .progress-fill { background: #28a745; height: 100%; border-radius: 10px; }
        #modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; width:90%; max-width:850px; padding:35px; border-radius:12px; position:relative; max-height: 90vh; overflow-y:auto; }
        #pdf-area { background: white; padding: 10px; }
        #mini-map { height: 350px; background: #eee; margin: 20px 0; border-radius: 8px; border: 1px solid #ddd; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        
        /* Buttons */
        .btn-export { background:#28a745; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-weight:bold; }
        .btn-close { background:#6c757d; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; }
        .btn-reset { background:#6c757d; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-weight:bold; }
        .btn-reset:hover { background:#5a6268; }
        
        .doc-btn { display: inline-block; padding: 8px 15px; background: #f0f7ff; color: #007bff; border: 1px solid #007bff; border-radius: 4px; text-decoration: none; font-weight: bold; margin-top: 5px; }
        .doc-btn:hover { background: #007bff; color: white; }
    </style>
</head>
<body>

<div id="modal">
    <div class="modal-content">
        <div style="float:right; margin-bottom: 10px;">
            <button class="btn-export" onclick="exportToPDF()">Export to PDF</button>
            <button class="btn-close" onclick="closeModal()">✕ Close</button>
        </div>

        <div id="pdf-area">
            <h1 id="mName" style="color:#007bff; margin:0;"></h1>
            <p id="mCategoryText" style="color:#666; margin: 5px 0; font-weight: bold;"></p>
            <div id="mini-map"></div>
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; font-size: 14px;">Project Completion:</label>
                <div class="progress-container" style="height: 20px; background: #e9ecef;">
                    <div id="mProgressBar" class="progress-fill"></div>
                </div>
                <span id="mProgressLabel" style="font-weight: bold; color: #28a745;"></span>
            </div>
            <div id="mDocContainer" style="margin-bottom: 20px;">
                <strong>Official Documents:</strong><br>
                <a id="mDocLink" href="#" target="_blank" class="doc-btn">View Project Documentation →</a>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <p><strong>Status:</strong> <span id="mStatusText"></span></p>
                    <p><strong>Timeline:</strong> <span id="mTimeline"></span></p>
                    <p><strong>Engineer:</strong> <span id="mEngineer"></span></p>
                </div>
                <div>
                    <p><strong>Contractor:</strong> <span id="mContractor"></span></p>
                    <p><strong>Award Amount:</strong> <span id="mAward"></span></p>
                </div>
            </div>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <h3>Project Scope</h3>
            <p id="mDesc" style="white-space: pre-line; line-height: 1.6;"></p>
        </div>
    </div>
</div>

<header><h1>City of Sulphur | Capital Improvements</h1></header>

<div class="controls">
    <input type="text" id="search" placeholder="Search projects..." onkeyup="render()">
    <select id="filterLayer" onchange="render()"><option value="all">All Categories</option></select>
    <select id="filterStatus" onchange="render()">
        <option value="all">All Statuses</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
    </select>
    <button class="btn-reset" onclick="resetFilters()">Reset Filters</button>
</div>

<div id="map"></div>
<div class="grid" id="listView"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const mainMap = L.map('map').setView([30.2366, -93.3774], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mainMap);
    const fGroup = L.featureGroup().addTo(mainMap);
    let projects = [];
    let miniMap = null;

    function displayDate(dateStr) {
        if (!dateStr || dateStr === "0000-00-00" || dateStr === "TBA") return "TBA";
        if (dateStr.includes('/')) return dateStr;
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
        return dateStr;
    }

    async function init() {
        const [lRes, pRes] = await Promise.all([fetch('api.php?action=get_layers'), fetch('api.php?action=get_projects')]);
        const layers = await lRes.json();
        projects = await pRes.json();
        const sel = document.getElementById('filterLayer');
        layers.forEach(l => sel.innerHTML += `<option value="${l.id}">${l.name}</option>`);
        render();
    }

    function resetFilters() {
        document.getElementById('search').value = "";
        document.getElementById('filterLayer').value = "all";
        document.getElementById('filterStatus').value = "all";
        render();
    }

    function openModal(id) {
        const p = projects.find(x => x.id == id);
        const percent = p.progress || 0;

        document.getElementById('mName').innerText = p.name;
        document.getElementById('mCategoryText').innerText = p.layer_name;
        document.getElementById('mProgressLabel').innerText = percent + "% Complete";
        document.getElementById('mProgressBar').style.width = percent + "%";
        document.getElementById('mStatusText').innerText = parseInt(percent) >= 100 ? "Completed" : "In Progress";
        document.getElementById('mDesc').innerText = p.description;
        
        const start = displayDate(p.start_date);
        const end = displayDate(p.completion_date);
        document.getElementById('mTimeline').innerText = `${start} to ${end}`;
        
        document.getElementById('mEngineer').innerText = p.engineer || "TBA";
        document.getElementById('mContractor').innerText = p.contractor || "TBA";

        let amt = p.award_amount || "TBA";
        if (amt !== "TBA" && !amt.startsWith('$')) {
            amt = '$' + amt;
        }
        document.getElementById('mAward').innerText = amt;

        const docContainer = document.getElementById('mDocContainer');
        const docLink = document.getElementById('mDocLink');
        if (p.doc_link && p.doc_link.trim() !== "") {
            docContainer.style.display = 'block';
            docLink.href = p.doc_link;
        } else {
            docContainer.style.display = 'none';
        }

        document.getElementById('modal').style.display = 'flex';
        
        if(miniMap) miniMap.remove();
        miniMap = L.map('mini-map', {
            attributionControl: false, zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false, touchZoom: false
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);

        setTimeout(() => {
            miniMap.invalidateSize();
            if(p.geometry) {
                const geo = L.geoJSON(p.geometry, {
                    style: { color: p.color, weight: 8, opacity: 1 },
                    pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 10, fillColor: p.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 })
                }).addTo(miniMap);
                miniMap.fitBounds(geo.getBounds(), {padding:[30,30]});
            }
        }, 150);
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function exportToPDF() {
        const element = document.getElementById('pdf-area');
        const projectName = document.getElementById('mName').innerText;
        const opt = {
            margin: [10, 10, 10, 10],
            filename: projectName + '_Report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function render() {
        fGroup.clearLayers();
        const query = document.getElementById('search').value.toLowerCase();
        const layerFilter = document.getElementById('filterLayer').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const list = document.getElementById('listView');
        list.innerHTML = "";

        projects.forEach(p => {
            // Updated Search Logic: Checks Name, Description, Engineer, and Contractor
            const searchableText = `${p.name} ${p.description || ''} ${p.engineer || ''} ${p.contractor || ''}`.toLowerCase();
            const matchesSearch = searchableText.includes(query);
            
            const matchesLayer = (layerFilter === 'all' || p.layer_id == layerFilter);
            let matchesStatus = (statusFilter === 'all') || 
                                (statusFilter === 'in_progress' && parseInt(p.progress) < 100) || 
                                (statusFilter === 'completed' && parseInt(p.progress) >= 100);

            if(matchesSearch && matchesLayer && matchesStatus) {
                L.geoJSON(p.geometry, {
                    style: { color: p.color, weight: 5, opacity: 0.8 },
                    pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 8, fillColor: p.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 })
                }).on('click', () => openModal(p.id)).addTo(fGroup);
                
                const percent = p.progress || 0;
                list.innerHTML += `
                    <div class="card" style="border-left-color:${p.color}" onclick="openModal(${p.id})">
                        <small style="text-transform: uppercase; font-weight: bold; color: #666;">${p.layer_name}</small>
                        <h3 style="margin: 5px 0;">${p.name}</h3>
                        <div class="progress-container"><div class="progress-fill" style="width: ${percent}%"></div></div>
                        <p style="font-size: 12px; margin: 0; font-weight: bold;">${percent}% Complete</p>
                    </div>`;
            }
        });

        if (fGroup.getLayers().length > 0) {
            mainMap.fitBounds(fGroup.getBounds(), { padding: [50, 50] });
        }
    }
    
    if (window.self !== window.top) {
        document.querySelector('header').style.display = 'none';
        document.getElementById('map').style.height = '400px';
    }
    
    init();
</script>
</body>
</html>
